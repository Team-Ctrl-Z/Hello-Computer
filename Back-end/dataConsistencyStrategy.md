1. 문제상황 (가정)
전자상거래 서비스를 마이크로서비스 구조로 개발 중이며, 주문(Order) 과 결제(Payment) 기능이 각기 다른 서비스로 분리되어 있습니다.
이때 사용자 결제는 성공했지만 주문 상태가 갱신되지 않거나, 주문은 되었지만 결제가 되지 않은 상태가 발생해 데이터 불일치 문제가 발생할 수 있습니다.

2. 분석과정
서비스 간에 API 호출을 통해 동기 방식으로 상태를 갱신하면, 한 쪽에서 장애가 발생할 경우 전체 흐름이 중단되거나 데이터 정합성(consistency) 이 깨질 수 있습니다.

이러한 문제는 마이크로서비스 간의 통신이 네트워크 장애나 지연, 비동기 처리 실패 등에 의해 언제든 발생할 수 있기 때문에 주의가 필요합니다.

3. 원인 (기술적 관점)
이 상황에서의 핵심 원인은 다음과 같습니다:

분산 트랜잭션이 적용되지 않은 상태에서 서로 다른 DB를 가진 서비스 간 상태 전파 실패

단일 트랜잭션으로 묶이지 않는 서비스 호출 구조

장애 상황 발생 시 처리 로직의 불완전함 (보상 로직 없음)

관련 개념 설명

분산 트랜잭션(distributed transaction): 여러 DB나 시스템 간의 데이터 일관성을 보장하려는 기법이지만, 성능 저하와 복잡도 증가로 인해 마이크로서비스에서는 잘 쓰이지 않음.

CAP 이론: 분산 시스템에서 Consistency(일관성), Availability(가용성), Partition tolerance(분할 허용성) 중 2개만 동시에 만족 가능. 마이크로서비스에서는 일반적으로 "최종 일관성(eventual consistency)"을 택함.

4. 개선 조치 (설계 제안)
저는 다음과 같은 개선안을 설계할 것입니다:

SAGA 패턴 적용
정의: 분산된 로컬 트랜잭션을 순차적으로 실행하고, 실패 시 이전 트랜잭션을 보상하는 방식

구현: 주문이 생성되면 ‘주문 생성됨’ 이벤트를 발행 → 결제 서비스는 이를 구독하고 결제 시도 → 성공 시 ‘결제 완료’ 이벤트 발행 → 주문 서비스는 이를 받아 상태 갱신

보상 트랜잭션: 결제 실패 시 주문을 자동으로 취소

이벤트 기반 아키텍처
Kafka 같은 메시지 큐를 사용하여 서비스 간 비동기적으로 통신

이벤트 발행/구독을 통해 상태를 전파하되, 실패 시 재시도 및 로그 기록

5. 기대 결과 (예상)
최종 일관성(Eventual Consistency) 확보: 모든 서비스가 시간차를 두고 일관된 상태에 도달

단일 서비스 장애에도 전체 흐름 중단 없이 복구 가능

모니터링과 로깅 체계를 통해 상태 추적이 용이해짐

+ 보완 요소

Dead Letter Queue로 실패한 메시지 보관

이벤트 중복 방지를 위한 메시지 ID 관리